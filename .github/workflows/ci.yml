name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Lint YAML files
      uses: ibiqlik/action-yamllint@v3
      with:
        file_or_dir: infra/lan-runner/
        config_file: .yamllint.yml
    - name: Lint Kubernetes manifests
      uses: instrumenta/kubeval-action@master
      with:
        files: infra/lan-runner/k8s/

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker
      run: docker --version
    - name: Validate configuration
      run: |
        cd infra/lan-runner
        cp .env.example .env
        echo "RUNNER_TOKEN=dummy_token_for_ci" >> .env
        echo "REPO_URL=https://github.com/tzervas/lan-runner" >> .env
        ./test.sh || echo "Test script ran with expected warnings (services not running)"
    - name: Test Docker Compose config
      run: |
        cd infra/lan-runner
        docker compose config
        docker compose -f docker-compose.yml -f docker-compose.lite.yml config
        docker compose -f docker-compose.yml -f docker-compose.gpu.yml config